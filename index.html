<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIæ–‡ç« æ¶¦è‰²å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .status-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .status-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
    }

    .progress-fill.warning {
      background: linear-gradient(90deg, #f093fb, #f5576c);
    }

    .progress-fill.danger {
      background: linear-gradient(90deg, #fa709a, #fee140);
    }

    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 24px;
      font-size: 12px;
      font-weight: 600;
      color: #333;
    }

    .status-details {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: #666;
    }

    .main-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .input-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .output-section {
      margin-bottom: 20px;
    }

    .output-box {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      min-height: 150px;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
    }

    .output-box.placeholder {
      color: #999;
      font-style: italic;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .style-selector {
      flex: 1;
      min-width: 200px;
    }

    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      cursor: pointer;
      background: white;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .button {
      padding: 12px 32px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .button-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button-secondary:hover {
      background: #e0e0e0;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alert {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .alert-error {
      background: #fee;
      color: #c00;
      border: 1px solid #fcc;
    }

    .alert-success {
      background: #efe;
      color: #080;
      border: 1px solid #cfc;
    }

    .hidden {
      display: none;
    }

    .token-info {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>âœ¨ AIæ–‡ç« æ¶¦è‰²å™¨</h1>
      <p>è®©æ‚¨çš„æ–‡å­—æ›´åŠ ä¸“ä¸šã€ç”ŸåŠ¨ã€æœ‰è¯´æœåŠ›</p>
    </div>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="status-card">
      <div class="status-header">
        <span class="status-title">ğŸ“Š æˆ‘çš„é¢åº¦</span>
        <button class="button button-secondary" onclick="refreshStatus()" style="padding: 6px 16px; font-size: 14px;">
          ğŸ”„ åˆ·æ–°
        </button>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        <div class="progress-text" id="progressText">åŠ è½½ä¸­...</div>
      </div>
      <div class="status-details">
        <span id="usedText">å·²ç”¨: -</span>
        <span id="limitText">æ€»é¢åº¦: -</span>
        <span id="remainingText">å‰©ä½™: -</span>
      </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div class="alert alert-error hidden" id="errorAlert"></div>

    <!-- æˆåŠŸæç¤º -->
    <div class="alert alert-success hidden" id="successAlert"></div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="main-card">
      <!-- è¾“å…¥åŒº -->
      <div class="input-section">
        <div class="section-title">ğŸ“ åŸæ–‡</div>
        <textarea id="inputText" placeholder="è¯·è¾“å…¥éœ€è¦æ¶¦è‰²çš„æ–‡ç« å†…å®¹..."></textarea>
      </div>

      <!-- æ§åˆ¶åŒº -->
      <div class="controls">
        <div class="style-selector">
          <select id="styleSelect">
            <option value="professional">ä¸“ä¸šæ­£å¼</option>
            <option value="casual">è½»æ¾è‡ªç„¶</option>
            <option value="concise">ç®€æ´æ˜äº†</option>
            <option value="creative">åˆ›æ„ç”ŸåŠ¨</option>
          </select>
        </div>
        <button class="button button-primary" id="polishBtn" onclick="polish()">
          âœ¨ å¼€å§‹æ¶¦è‰²
        </button>
        <button class="button button-secondary" onclick="clearAll()">
          ğŸ—‘ï¸ æ¸…ç©º
        </button>
      </div>

      <!-- Tokenä¿¡æ¯ -->
      <div class="token-info" id="tokenInfo"></div>

      <!-- è¾“å‡ºåŒº -->
      <div class="output-section" style="margin-top: 20px;">
        <div class="section-title">ğŸ¯ æ¶¦è‰²ç»“æœ</div>
        <div class="output-box placeholder" id="outputBox">æ¶¦è‰²åçš„æ–‡ç« å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
      </div>

      <!-- å¤åˆ¶æŒ‰é’® -->
      <button class="button button-secondary" onclick="copyResult()" id="copyBtn" style="display: none;">
        ğŸ“‹ å¤åˆ¶ç»“æœ
      </button>
    </div>
  </div>

  <script>
    // å®¢æˆ·ID - å®é™…éƒ¨ç½²æ—¶åº”è¯¥ä»URLå‚æ•°æˆ–ç™»å½•çŠ¶æ€è·å–
    const CLIENT_ID = new URLSearchParams(window.location.search).get('client') || 'demo_client';
    const API_BASE = window.location.origin;

    // é¡µé¢åŠ è½½æ—¶è·å–çŠ¶æ€
    window.onload = function() {
      refreshStatus();
    };

    // åˆ·æ–°çŠ¶æ€
    async function refreshStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/status?clientId=${CLIENT_ID}`);
        const data = await response.json();

        if (response.ok) {
          updateStatusDisplay(data.usage);
        } else {
          showError('è·å–çŠ¶æ€å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
      }
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatusDisplay(usage) {
      const percentage = parseFloat(usage.percentage);
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');

      fill.style.width = percentage + '%';
      text.textContent = `${usage.percentage} (${usage.used.toLocaleString()} / ${usage.limit.toLocaleString()} tokens)`;

      // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
      fill.classList.remove('warning', 'danger');

      if (usage.isExhausted) {
        fill.classList.add('danger');
        showError('âš ï¸ é¢åº¦å·²ç”¨å®Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜å……å€¼');
      } else if (usage.isNearLimit) {
        fill.classList.add('warning');
        showError('âš ï¸ é¢åº¦å³å°†ç”¨å°½ï¼Œè¯·åŠæ—¶å……å€¼');
      }

      document.getElementById('usedText').textContent = `å·²ç”¨: ${usage.used.toLocaleString()} tokens`;
      document.getElementById('limitText').textContent = `æ€»é¢åº¦: ${usage.limit.toLocaleString()} tokens`;
      document.getElementById('remainingText').textContent = `å‰©ä½™: ${usage.remaining.toLocaleString()} tokens`;
    }

    // æ¶¦è‰²æ–‡ç« 
    async function polish() {
      const text = document.getElementById('inputText').value.trim();
      const style = document.getElementById('styleSelect').value;
      const btn = document.getElementById('polishBtn');

      if (!text) {
        showError('è¯·è¾“å…¥éœ€è¦æ¶¦è‰²çš„æ–‡ç« å†…å®¹');
        return;
      }

      // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºloading
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>æ¶¦è‰²ä¸­...';

      hideAlerts();
      document.getElementById('outputBox').textContent = 'æ­£åœ¨æ¶¦è‰²ï¼Œè¯·ç¨å€™...';
      document.getElementById('outputBox').classList.remove('placeholder');

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clientId: CLIENT_ID,
            text: text,
            style: style
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          document.getElementById('outputBox').textContent = data.polishedText;
          document.getElementById('outputBox').classList.remove('placeholder');
          document.getElementById('copyBtn').style.display = 'inline-block';

          // æ˜¾ç¤ºtokenæ¶ˆè€—
          document.getElementById('tokenInfo').textContent =
            `æœ¬æ¬¡æ¶ˆè€—: ${data.tokensUsed} tokens | å‰©ä½™: ${data.remaining.toLocaleString()} tokens`;

          // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
          updateStatusDisplay(data.usage);

          showSuccess('âœ¨ æ¶¦è‰²å®Œæˆï¼');
        } else {
          showError(data.error || 'æ¶¦è‰²å¤±è´¥');
          document.getElementById('outputBox').textContent = 'æ¶¦è‰²å¤±è´¥ï¼Œè¯·é‡è¯•';
          document.getElementById('outputBox').classList.add('placeholder');
        }
      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
        document.getElementById('outputBox').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
        document.getElementById('outputBox').classList.add('placeholder');
      }

      // æ¢å¤æŒ‰é’®
      btn.disabled = false;
      btn.innerHTML = 'âœ¨ å¼€å§‹æ¶¦è‰²';
    }

    // æ¸…ç©ºæ‰€æœ‰
    function clearAll() {
      document.getElementById('inputText').value = '';
      document.getElementById('outputBox').textContent = 'æ¶¦è‰²åçš„æ–‡ç« å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
      document.getElementById('outputBox').classList.add('placeholder');
      document.getElementById('copyBtn').style.display = 'none';
      document.getElementById('tokenInfo').textContent = '';
      hideAlerts();
    }

    // å¤åˆ¶ç»“æœ
    function copyResult() {
      const text = document.getElementById('outputBox').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = 'âœ… å·²å¤åˆ¶';
        setTimeout(() => {
          btn.textContent = 'ğŸ“‹ å¤åˆ¶ç»“æœ';
        }, 2000);
      });
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      const alert = document.getElementById('errorAlert');
      alert.textContent = message;
      alert.classList.remove('hidden');
      document.getElementById('successAlert').classList.add('hidden');
    }

    // æ˜¾ç¤ºæˆåŠŸ
    function showSuccess(message) {
      const alert = document.getElementById('successAlert');
      alert.textContent = message;
      alert.classList.remove('hidden');
      document.getElementById('errorAlert').classList.add('hidden');
    }

    // éšè—æ‰€æœ‰æç¤º
    function hideAlerts() {
      document.getElementById('errorAlert').classList.add('hidden');
      document.getElementById('successAlert').classList.add('hidden');
    }
  </script>
</body>
</html>
